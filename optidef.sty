% optidef - Version 1.1
%
%Copyright 2016 J. Lago Garcia
%
%This work may be distributed and/or modified under the conditions of the LaTeX Project Public License, either version 1.3 of this license or (at your option) any later version.
%The latest version of this license is in http://www.latex-project.org/lppl.txt and version 1.3 or later is part of all distributions of LaTeX version 2005/12/01 or later.
%
%This work has the LPPL maintenance status 'maintained'. The Current Maintainer of this work is J. Lago Garcia, under the supervision of Prof. Dr. Moritz Diehl and Prof. Dr. Sebastien Gross.
%
%E-mail: jesus.lago.garcia@venus.uni-freiburg.de
%
%This work consists of the file optidef.sty.

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{optidef}[2016/06/26 - version=1.1,  Package for defining optimization problems]

\RequirePackage{environ}
\RequirePackage{mathtools}	
\RequirePackage{xifthen}	
\RequirePackage{etoolbox}	
\RequirePackage{xparse}	
\newtoggle{bodyCon}
\toggletrue{bodyCon}

% Input minimization evironments

% Macros for objective definition, constraint definition and extra constraint definition
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% % -------- DEFINITION COMMAND OBJECTIVE  -----------
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\bodyobj}[4]
{
	\ifthenelse{\isempty{#4}}
	{
		&\underset{\displaystyle #1}{\mathrm{#3}} \quad #2\span\span\span\span
	}
	{
		#4 ~~ &\underset{\displaystyle #1}{\mathrm{#3}} \quad #2\span\span\span\span
	}
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  -------- DEFINITION DIFFERENT TYPE OF BODY CONSTRAINTS  --------%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\DeclareDocumentCommand{\bodyconst}{m G{}}
{	\ifthenelse{\equal{#2}{}}{
	\\ &\mathrm{subject~to} \quad &&#1 #2
	}{
	\\ &\mathrm{subject~to} \quad &#1 & #2
	}
}

% Standard version
\DeclareDocumentCommand{\bodyconstRight}{m G{}}
{	\ifthenelse{\equal{#2}{}}{
		\\ &\mathrm{subject~to} \quad &&#1 #2
	}{
	\\ &\mathrm{subject~to} \quad &#1 & #2
}
}

% Single alignment point
\DeclareDocumentCommand{\bodyconstOneAlign}{m G{}}
{
	\\ &\mathrm{subject~to} \quad &&#1 #2
}

% Contraints below subject to and with a single alignment point
\DeclareDocumentCommand{\bodyconstOneAlignBelow}{m G{}}
{
		\\ &\mathrm{subject~to} \span\span \\
		&&&#1 #2		
}

% Contraints below subject to
\DeclareDocumentCommand{\bodyconstBelow}{m G{}}
{	\ifthenelse{\equal{#2}{}}{
		\\ &\mathrm{subject~to} \span\span\span\span \\
		&&&#1 #2		
	}{
	\\ &\mathrm{subject~to} \span\span\span\span \\
	 &&#1 & #2
	}
}

% Contraints below subject to for the case of having multiple equations
\DeclareDocumentCommand{\bodyconstBelowMult}{m G{}}
{	\ifthenelse{\equal{#2}{}}{
		\\ &\mathrm{subject~to} \span\span\span\span \nonumber \\
		&&&#1 #2		
	}{
	\\ &\mathrm{subject~to} \span\span\span\span \nonumber \\
	&&#1 & #2
}
}

% Contraints below subject to and with a single alignment point for the case of having several equations
\DeclareDocumentCommand{\bodyconstOneAlignBelowMult}{m G{}}
{
	\\ &\mathrm{subject~to} \span\span\span\span \nonumber \\
	&&&#1 #2		
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  -------- DEFINITION DIFFERENT TYPE OF ADDING CONSTRAINTS  --- --%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\DeclareDocumentCommand{\addConstraint}{m G{} G{}}{
	\ifthenelse{\equal{#2}{}}{
		\iftoggle{bodyCon}{
			\bodyconst{#1}
			\togglefalse{bodyCon}
		}{
		,\\&\quad &&#1 #2
		\togglefalse{bodyCon}
			}
	}{
		\iftoggle{bodyCon}{
			\bodyconst{#1}{#2}
			\togglefalse{bodyCon}
		}{
		,\\&\quad &#1 & #2
		\togglefalse{bodyCon}
		}
	}
}

% Standard version of adding constraints
\DeclareDocumentCommand{\standardAddConstraint}{m G{} G{}}{
\iftoggle{bodyCon}{
	\bodyconstRight{#1}{#2}
	\togglefalse{bodyCon}
}{
	\ifthenelse{\equal{#2}{}}{
		,\\&\quad &&#1 #2
	}{
		,\\&\quad &#1 & #2
}
\togglefalse{bodyCon}
}
}

% Adding constraints below subject to
\DeclareDocumentCommand{\BelowAddConstraint}{m G{} G{}}{
	\iftoggle{bodyCon}{
		\bodyconstBelow{#1}{#2}
		\togglefalse{bodyCon}
	}{
	\ifthenelse{\equal{#2}{}}{
		,\\&&&#1  #2
		\togglefalse{bodyCon}
	}{
	,\\ &&#1  &#2}
	\togglefalse{bodyCon}
}
}

% Adding constraints for a single alignment point
\DeclareDocumentCommand{\oneAlignAddConstraint}{m G{} G{}}{
		\iftoggle{bodyCon}{
			\bodyconstOneAlign{#1}{#2}
			\togglefalse{bodyCon}
		}{
		,\\&\quad &&#1  #2
		\togglefalse{bodyCon}
		}
}

% Adding constraints for a single alignment point and with the constraints below
\DeclareDocumentCommand{\oneAlignBelowAddConstraint}{m G{} G{}}{
	\iftoggle{bodyCon}{
		\bodyconstOneAlignBelow{#1}{#2}
		\togglefalse{bodyCon}
	}{
	,\\& &&#1  #2
	\togglefalse{bodyCon}
}
}

% Adding constraints below subject to for multiple references
\DeclareDocumentCommand{\BelowAddConstraintMult}{m G{} G{}}{
	\iftoggle{bodyCon}{
		\bodyconstBelowMult{#1}{#2}
		\togglefalse{bodyCon}
	}{
	\ifthenelse{\equal{#2}{}}{
		,\\&&&#1  #2
		\togglefalse{bodyCon}
	}{
	,\\ &&#1  &#2}
\togglefalse{bodyCon}
}
}

% Adding constraints for a single alignment point and with the constraints below for multiple references
\DeclareDocumentCommand{\oneAlignBelowAddConstraintMult}{m G{} G{}}{
	\iftoggle{bodyCon}{
		\bodyconstOneAlignBelowMult{#1}{#2}
		\togglefalse{bodyCon}
	}{
	,\\& &&#1  #2
	\togglefalse{bodyCon}
}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  ------------- SELECTING TYPE OF FORMAT  -----------%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\selectConstraint}[1]{
	\ifthenelse{\equal{#1}{1}}{
		\let\addConstraint\BelowAddConstraint
	}{
	\ifthenelse{\equal{#1}{2}}{
		\let\addConstraint\oneAlignAddConstraint
	}{
	\ifthenelse{\equal{#1}{3}}{
		\let\addConstraint\oneAlignBelowAddConstraint
	}{
		\let\addConstraint\standardAddConstraint}
}
}
}

% Selecting for multiple references
\newcommand{\selectConstraintMult}[1]{
	\ifthenelse{\equal{#1}{1}}{
		\let\addConstraint\BelowAddConstraintMult
	}{
	\ifthenelse{\equal{#1}{2}}{
		\let\addConstraint\oneAlignAddConstraint
	}{
	\ifthenelse{\equal{#1}{3}}{
		\let\addConstraint\oneAlignBelowAddConstraintMult
	}{
	\let\addConstraint\standardAddConstraint}
}
}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  ------------- SETTING DEFAULT FORMAT  -------------%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\setStandardMini}{
	\toggletrue{bodyCon}
	\let\addConstraint\standardAddConstraint	
}


\newcommand{\breakObjectiveOneConstraint}[1]{&&&#1\\}



%MINIMIZATION ENVIRONMENTS

\NewEnviron{mini}[5][]{%
\selectConstraint{#1}
	\begin{equation}
	#4
	\begin{alignedat}{5}
	\bodyobj{#2}{#3}{minimize}{#5}
	\BODY
	\end{alignedat}
	\end{equation}
\setStandardMini
}

\NewEnviron{argmini}[5][]{%
\selectConstraint{#1}
	\begin{equation}
	#4
	\begin{alignedat}{5}
	\bodyobj{#2}{#3}{arg min}{#5}
	\BODY
	\end{alignedat}
	\end{equation}
\setStandardMini
}

\NewEnviron{mini*}[5][]{%
\selectConstraint{#1}
	\begin{equation*}
	#4
	\begin{alignedat}{5}
	\bodyobj{#2}{#3}{minimize}{#5}
	\BODY
	\end{alignedat}
\end{equation*}
\setStandardMini
}

\NewEnviron{argmini*}[5][]{%
\selectConstraint{#1}
	\begin{equation*}
	#4
	\begin{alignedat}{5}
	\bodyobj{#2}{#3}{arg min}{#5}
	\BODY
	\end{alignedat}
	\end{equation*}
\setStandardMini	
}


\NewEnviron{mini!}[5][]{%
\selectConstraintMult{#1}
	\begin{subequations}
		#4
		\begin{alignat}{5}
		\bodyobj{#2}{#3}{minimize}{#5}
		\BODY
		\end{alignat}
	\end{subequations}
\setStandardMini
}

\NewEnviron{argmini!}[5][]{%
\selectConstraintMult{#1}
	\begin{subequations}
		#4
		\begin{alignat}{5}
		\bodyobj{#2}{#3}{arg min}{#5}
		\BODY
		\end{alignat}
	\end{subequations}	
\setStandardMini		
}

%MAXIMIZATION ENVIRONMENTS

\NewEnviron{maxi}[5][]{%
\selectConstraint{#1}
	\begin{equation}
	#4
	\begin{alignedat}{5}
	\bodyobj{#2}{#3}{maximize}{#5}
	\BODY
	\end{alignedat}
	\end{equation}
\setStandardMini
}

\NewEnviron{argmaxi}[5][]{%
\selectConstraint{#1}
	\begin{equation}
	#4
	\begin{alignedat}{5}
	\bodyobj{#2}{#3}{arg maxi}{#5}
	\BODY
	\end{alignedat}
	\end{equation}
\setStandardMini
}

\NewEnviron{maxi*}[5][]{%
\selectConstraint{#1}
	\begin{equation*}
	#4
	\begin{alignedat}{5}
	\bodyobj{#2}{#3}{maximize}{#5}
	\BODY
	\end{alignedat}
	\end{equation*}
\setStandardMini
}

\NewEnviron{argmaxi*}[5][]{%
\selectConstraint{#1}
	\begin{equation*}
	#4
	\begin{alignedat}{5}
	\bodyobj{#2}{#3}{arg maxi}{#5}
	\BODY
	\end{alignedat}
	\end{equation*}
\setStandardMini
}


\NewEnviron{maxi!}[5][]{%
\selectConstraintMult{#1}
	\begin{subequations}
		#4
		\begin{alignat}{5}
		\bodyobj{#2}{#3}{maximize}{#5}		
		\BODY
		\end{alignat}
	\end{subequations}	
\setStandardMini		
}

\NewEnviron{argmaxi!}[5][]{%
\selectConstraintMult{#1}
	\begin{subequations}
		#4
		\begin{alignat}{5}
		\bodyobj{#2}{#3}{arg maxi}{#5}		
		\BODY
		\end{alignat}
	\end{subequations}
\setStandardMini			
}