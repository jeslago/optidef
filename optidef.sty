% optidef - Version 1.0
%
%Copyright 2016 J. Lago Garcia
%
%This work may be distributed and/or modified under the conditions of the LaTeX Project Public License, either version 1.3 of this license or (at your option) any later version.
%The latest version of this license is in http://www.latex-project.org/lppl.txt and version 1.3 or later is part of all distributions of LaTeX version 2005/12/01 or later.
%
%This work has the LPPL maintenance status 'maintained'. The Current Maintainer of this work is J. Lago Garcia, under the supervision of Prof. Dr. Moritz Diehl and Prof. Dr. Sebastien Gross.
%
%E-mail: jesus.lago.garcia@venus.uni-freiburg.de
%
%This work consists of the file optidef.sty.

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{optidef}[2016/06/06 Package for defining optimization problems]

\RequirePackage{environ}
\RequirePackage{mathtools}	
\RequirePackage{xifthen}	
\RequirePackage{etoolbox}	
\RequirePackage{xparse}	
\newtoggle{bodyCon}
\toggletrue{bodyCon}

% Input minimization evironments

% Macros for objective definition, constraint definition and extra constraint definition
\newcommand{\bodyobj}[4]
{
	\ifthenelse{\isempty{#4}}
	{
		&\underset{\displaystyle #1}{\mathrm{#3}} \quad #2\span\span\span\span
	}
	{
		#4 ~~ &\underset{\displaystyle #1}{\mathrm{#3}} \quad #2\span\span\span\span
	}
}


\DeclareDocumentCommand{\bodyconst}{m G{}}
{	\ifthenelse{\equal{#2}{}}{
	\\ &\mathrm{subject~to} \quad &&#1 #2
	}{
	\\ &\mathrm{subject~to} \quad &#1 & #2
	}
}

\DeclareDocumentCommand{\bodyconstOneAlign}{m}
{
	\\ &\mathrm{subject~to} \quad &&#1 #2
}

\DeclareDocumentCommand{\bodyconstOneAlignBelow}{m}
{
		\\ &\mathrm{subject~to} \span\span \\
		&\quad&&#1 #2		
}

\DeclareDocumentCommand{\bodyconstBelow}{m G{}}
{	\ifthenelse{\equal{#2}{}}{
		\\ &\mathrm{subject~to} \span\span \\
		&\quad&&#1 #2		
	}{
	\\ &\mathrm{subject~to} \span\span \\
	 &\quad&#1 & #2
	}
}

\DeclareDocumentCommand{\bodyconstRight}{m G{}}
{	\ifthenelse{\equal{#2}{}}{
		\\ &\mathrm{subject~to} \quad &&#1 #2
	}{
	\\ &\mathrm{subject~to} \quad &#1 & #2
}
}

\DeclareDocumentCommand{\bodyconstBelowMult}{m G{}}
{	\ifthenelse{\equal{#2}{}}{
		\\ &\mathrm{subject~to} \span\span\span\span \nonumber \\
		&\quad&&#1 #2		
	}{
	\\ &\mathrm{subject~to} \span\span\span\span \nonumber \\
	&\quad&#1 & #2
}
}


\DeclareDocumentCommand{\addConstraint}{m G{} G{}}{
	\ifthenelse{\equal{#2}{}}{
		\iftoggle{bodyCon}{
			\bodyconst{#1}
			\togglefalse{bodyCon}
		}{
		,\\&\quad &&#1 #2
		\togglefalse{bodyCon}
			}
	}{
		\iftoggle{bodyCon}{
			\bodyconst{#1}{#2}
			\togglefalse{bodyCon}
		}{
		,\\&\quad &#1 & #2
		\togglefalse{bodyCon}
		}
	}
}

\newcommand{\breakObjectiveOneConstraint}[1]{&&&#1\\}



%MINIMIZATION ENVIRONMENTS

\NewEnviron{mini}[5][]{%
	\ifthenelse{\equal{#1}{1}}{
			\let\bodyconst\bodyconstBelow
	}{
		\ifthenelse{\equal{#1}{2}}{
			\let\bodyconst\bodyconstOneAlign
		}{
			\ifthenelse{\equal{#1}{2}}{
			\let\bodyconst\bodyconstOneAlignBelow
			}{}
		}
	}
	\begin{equation}
	#4
	\begin{alignedat}{4}
	\bodyobj{#2}{#3}{minimize}{#5}
	\BODY
	\end{alignedat}
	\end{equation}
\toggletrue{bodyCon}
\let\bodyconst\bodyconstRight
}

\NewEnviron{argmini}[5][]{%
	\ifthenelse{\equal{#1}{1}}{
		\let\bodyconst\bodyconstBelow
	}{
	\ifthenelse{\equal{#1}{2}}{
		\let\bodyconst\bodyconstOneAlign
	}{
	\ifthenelse{\equal{#1}{2}}{
		\let\bodyconst\bodyconstOneAlignBelow
	}{}
}
}
	\begin{equation}
	#4
	\begin{alignedat}{4}
	\bodyobj{#2}{#3}{arg min}{#5}
	\BODY
	\end{alignedat}
	\end{equation}
}

\NewEnviron{mini*}[5][]{%
	\ifthenelse{\equal{#1}{1}}{
		\let\bodyconst\bodyconstBelow
	}{}
	\begin{equation*}
	#4
	\begin{alignedat}{4}
	\bodyobj{#2}{#3}{minimize}{#5}
	\BODY
	\end{alignedat}
\end{equation*}
\toggletrue{bodyCon}
\let\bodyconst\bodyconstRight
}

\NewEnviron{argmini*}[5][]{%
	\ifthenelse{\equal{#1}{1}}{
		\let\bodyconst\bodyconstBelow
	}{}
	\begin{equation*}
	#4
	\begin{alignedat}{4}
	\bodyobj{#2}{#3}{arg min}{#5}
	\BODY
	\end{alignedat}
	\end{equation*}
}


\NewEnviron{mini!}[5][]{%
	\ifthenelse{\equal{#1}{1}}{
		\let\bodyconst\bodyconstBelowMult
	}{}
	\begin{subequations}
		#4
		\begin{alignat}{4}
		\bodyobj{#2}{#3}{minimize}{#5}
		\BODY
		\end{alignat}
	\end{subequations}
	\toggletrue{bodyCon}
\let\bodyconst\bodyconstRight		
}

\NewEnviron{argmini!}[5][]{%
	\ifthenelse{\equal{#1}{1}}{
		\let\bodyconst\bodyconstBelowMult
	}{}
	\begin{subequations}
		#4
		\begin{alignat}{4}
		\bodyobj{#2}{#3}{arg min}{#5}
		\BODY
		\end{alignat}
	\end{subequations}			
}

%MAXIMIZATION ENVIRONMENTS

\NewEnviron{maxi}[5][]{%
	\ifthenelse{\equal{#1}{1}}{
		\let\bodyconst\bodyconstBelow
	}{}
	\begin{equation}
	#4
	\begin{alignedat}{4}
	\bodyobj{#2}{#3}{maximize}{#5}
	\BODY
	\end{alignedat}
	\end{equation}
}

\NewEnviron{argmaxi}[5][]{%
	\ifthenelse{\equal{#1}{1}}{
		\let\bodyconst\bodyconstBelow
	}{}
	\begin{equation}
	#4
	\begin{alignedat}{4}
	\bodyobj{#2}{#3}{arg maxi}{#5}
	\BODY
	\end{alignedat}
	\end{equation}
}

\NewEnviron{maxi*}[5][]{%
	\ifthenelse{\equal{#1}{1}}{
		\let\bodyconst\bodyconstBelow
	}{}
	\begin{equation*}
	#4
	\begin{alignedat}{4}
	\bodyobj{#2}{#3}{maximize}{#5}
	\BODY
	\end{alignedat}
	\end{equation*}
}

\NewEnviron{argmaxi*}[5][]{%
	\ifthenelse{\equal{#1}{1}}{
		\let\bodyconst\bodyconstBelow
	}{}
	\begin{equation*}
	#4
	\begin{alignedat}{4}
	\bodyobj{#2}{#3}{arg maxi}{#5}
	\BODY
	\end{alignedat}
	\end{equation*}
}


\NewEnviron{maxi!}[5][]{%
	\ifthenelse{\equal{#1}{1}}{
		\let\bodyconst\bodyconstBelowMult
	}{}
	\begin{subequations}
		#4
		\begin{alignat}{4}
		\bodyobj{#2}{#3}{maximize}{#5}		
		\BODY
		\end{alignat}
	\end{subequations}			
}

\NewEnviron{argmaxi!}[5][]{%
	\ifthenelse{\equal{#1}{1}}{
		\let\bodyconst\bodyconstBelowMult
	}{}
	\begin{subequations}
		#4
		\begin{alignat}{4}
		\bodyobj{#2}{#3}{arg maxi}{#5}		
		\BODY
		\end{alignat}
	\end{subequations}			
}