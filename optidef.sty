% optidef - Version 1.2
%
%Copyright 2016 J. Lago Garcia
%
%This work may be distributed and/or modified under the conditions of the LaTeX Project Public License, either version 1.3 of this license or (at your option) any later version.
%The latest version of this license is in http://www.latex-project.org/lppl.txt and version 1.3 or later is part of all distributions of LaTeX version 2005/12/01 or later.
%
%This work has the LPPL maintenance status 'maintained'. The Current Maintainer of this work is J. Lago Garcia, under the supervision of Prof. Dr. Moritz Diehl and Prof. Dr. Sebastien Gross.
%
%E-mail: jesus.lago.garcia@venus.uni-freiburg.de
%
%This work consists of the file optidef.sty.

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{optidef}[2016/06/28 - version=1.2,  Package for defining optimization problems]

\RequirePackage{environ}
\RequirePackage{mathtools}	
\RequirePackage{xifthen}	
\RequirePackage{etoolbox}	
\RequirePackage{xparse}	
\RequirePackage{multirow}	

% Toogle to indicate if during the addConstraint command the first constraint should be built together with "subject to"
\newtoggle{bodyCon}
\toggletrue{bodyCon}

% If the previous constraints has 3 elements, we avoid setting \span\span at the beginning of the next constraint. If there is no previous third element, \span\span must be included for correct alignment
\newtoggle{previousThird}
\togglefalse{previousThird}
\newcommand{\spanit}{}


% Macros for objective definition, constraint definition and extra constraint definition
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% % -------- DEFINITION COMMAND OBJECTIVE  -----------
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\bodyobj}[4]
{
	\ifthenelse{\isempty{#4}}
	{
		%&\underset{\displaystyle #1}{\mathrm{#3}} \quad #2\span\span\span\span
		&\underset{\displaystyle #1}{\mathrlap{\mathrm{#3}}\phantom{\mathrm{subject~to}}} \quad #2\span\span\span\span
	}
	{
		%#4 ~~ &\underset{\displaystyle #1}{\mathrm{#3}} \quad #2\span\span\span\span
		#4 ~~ &\underset{\displaystyle #1}{\mathrlap{\mathrm{#3}}\phantom{\mathrm{subject~to}}} \quad #2\span\span\span\span
	}
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  -------- DEFINITION DIFFERENT TYPE OF BODY CONSTRAINTS  --------%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\DeclareDocumentCommand{\bodyconst}{m G{}}
{	\ifthenelse{\equal{#2}{}}{
	\\ &\mathrm{subject~to} \quad &&#1 #2 
	}{
	\\ &\mathrm{subject~to} \quad &#1 & #2
	}
}

% Standard version
\DeclareDocumentCommand{\bodyconstRight}{m G{} G{}}
{	\ifthenelse{\equal{#3}{}}{
			\ifthenelse{\equal{#2}{}}{
			\\ &\mathrm{subject~to} \quad &&#1 #2 	
		}{
		\\ &\mathrm{subject~to} \quad &#1 & #2 
		}
		\togglefalse{previousThird}
	}{
		\ifthenelse{\equal{#2}{}}{
			\\ &\mathrm{subject~to} \quad &&#1 #2 &&#3
		}{
		\\ &\mathrm{subject~to} \quad &#1 & #2 &&#3
		}
		\toggletrue{previousThird}
	}
}

% Single alignment point
\DeclareDocumentCommand{\bodyconstOneAlign}{m G{} G{}}
{
	\ifthenelse{\equal{#3}{}}{
		\\ &\mathrm{subject~to} \quad &&#1 #2 	\togglefalse{previousThird}
	}{
		\\ &\mathrm{subject~to} \quad &&#1 #2 &&#3
		\toggletrue{previousThird}
	}
}

% Contraints below subject to and with a single alignment point
\DeclareDocumentCommand{\bodyconstOneAlignBelow}{m G{} G{}}
{
	\ifthenelse{\equal{#3}{}}{
		\\ &\mathrm{subject~to} \span\span\span\span \\
		&&&#1 #2 \togglefalse{previousThird}
	}{
		\\ &\mathrm{subject~to} \span\span\span\span \\
		&&&#1 #2 &&#3	
		\toggletrue{previousThird}
	}	
}

% Contraints below subject to
\DeclareDocumentCommand{\bodyconstBelow}{m G{} G{}}
{
	\ifthenelse{\equal{#3}{}}{
		\ifthenelse{\equal{#2}{}}{
			\\ &\mathrm{subject~to} \span\span\span\span \\
			&&&#1 #2 
		}{
		\\ &\mathrm{subject~to} \span\span\span\span \\
		 &&#1 & #2 
		}
		\togglefalse{previousThird}
	}{
		\ifthenelse{\equal{#2}{}}{
			\\ &\mathrm{subject~to} \span\span\span\span \\
			&&&#1 #2 &&#3
		}{
		\\ &\mathrm{subject~to} \span\span\span\span \\
		&&#1 & #2 &&#3
		}
		\toggletrue{previousThird}	
	}
}

% Contraints below subject to for the case of having multiple equations
\DeclareDocumentCommand{\bodyconstBelowMult}{m G{} G{}}
{
	\ifthenelse{\equal{#3}{}}{
		\ifthenelse{\equal{#2}{}}{
			\\ &\mathrm{subject~to} \span\span\span\span \nonumber \\
			&&&#1 #2	
		}{
		\\ &\mathrm{subject~to} \span\span\span\span \nonumber \\
		&&#1 & #2 
		}
		\togglefalse{previousThird}
	}{
		\ifthenelse{\equal{#2}{}}{
			\\ &\mathrm{subject~to} \span\span\span\span \nonumber \\
			&&&#1 #2	&&#3
		}{
		\\ &\mathrm{subject~to} \span\span\span\span \nonumber \\
		&&#1 & #2 &&#3
		}
		\toggletrue{previousThird}	
	}
}

% Contraints below subject to and with a single alignment point for the case of having several equations
\DeclareDocumentCommand{\bodyconstOneAlignBelowMult}{m G{} G{}}
{
	\ifthenelse{\equal{#3}{}}{
		\\ &\mathrm{subject~to} \span\span\span\span \nonumber \\
		&&&#1 #2		\togglefalse{previousThird}
	}{
		\\ &\mathrm{subject~to} \span\span\span\span \nonumber \\
		&&&#1 #2 &&	#3
		\toggletrue{previousThird}
	}
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  -------- DEFINITION DIFFERENT TYPE OF ADDING CONSTRAINTS  --- --%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\DeclareDocumentCommand{\addConstraint}{m G{} G{}}{
\ifthenelse{\equal{#3}{}}{	
		\ifthenelse{\equal{#2}{}}{
			\iftoggle{bodyCon}{
				\bodyconst{#1}
				\togglefalse{bodyCon}
			}{
			,\\&\quad &&#1 #2\span\span
			\togglefalse{bodyCon}
				}
		}{
			\iftoggle{bodyCon}{
				\bodyconst{#1}{#2}
				\togglefalse{bodyCon}
			}{
			,\\&\quad &#1 & #2\span\span
			\togglefalse{bodyCon}
			}
		}
			\togglefalse{previousThird}
	}{
			\iftoggle{bodyCon}{
				\bodyconst{#1}{#2}{#3}
				\togglefalse{bodyCon}
			}{
				\ifthenelse{\equal{#2}{}}{
					,\\&\quad &&#1 #2 && #3
				}{
					,\\&\quad &#1 & #2 && #3
				}
				\togglefalse{bodyCon}
			}
		\toggletrue{previousThird}
		}
}

% Standard version of adding constraints
\DeclareDocumentCommand{\standardAddConstraint}{m G{} G{}}{
	\iftoggle{previousThird}
	{\renewcommand{\spanit}{}}
	{\renewcommand{\spanit}{\span\span}}
\iftoggle{bodyCon}{
	\bodyconstRight{#1}{#2}{#3}
	\togglefalse{bodyCon}
}{
	\ifthenelse{\equal{#2}{}}{
		\ifthenelse{\equal{#3}{}}{
			,\spanit\\&\quad &&#1 #2 
			\togglefalse{previousThird}
		}{
			,\spanit\\&\quad &&#1 #2 && #3
			\toggletrue{previousThird}
		}
	}{
		\ifthenelse{\equal{#3}{}}{
			,\spanit\\&\quad &#1 & #2 
			\togglefalse{previousThird}
		}{
			,\spanit\\&\quad &#1 & #2 && #3
			\toggletrue{previousThird}
		}
}
\togglefalse{bodyCon}
}
}

% Adding constraints below subject to
\DeclareDocumentCommand{\BelowAddConstraint}{m G{} G{}}{
	\iftoggle{bodyCon}{
		\bodyconstBelow{#1}{#2}{#3}
		\togglefalse{bodyCon}
	}{
		\ifthenelse{\equal{#2}{}}{
			\ifthenelse{\equal{#3}{}}{
				,\spanit\\&&&#1  #2 		\togglefalse{previousThird}
			}{
				,\spanit\\&&&#1  #2 && #3
				\toggletrue{previousThird}		
			}
		}{
			\ifthenelse{\equal{#3}{}}{
				,\spanit\\ &&#1  &#2 \togglefalse{previousThird}
			}{
				,\spanit\\ &&#1  &#2 && #3
				\toggletrue{previousThird}
			}
		}
		\togglefalse{bodyCon}
	}
}

% Adding constraints for a single alignment point
\DeclareDocumentCommand{\oneAlignAddConstraint}{m G{} G{}}{
		\iftoggle{bodyCon}{
			\bodyconstOneAlign{#1}{#2}{#3}
			\togglefalse{bodyCon}
		}{
			\ifthenelse{\equal{#3}{}}{
				,\spanit\\&\quad &&#1  #2 \togglefalse{previousThird}
			}{
				,\spanit\\&\quad &&#1  #2 && #3
				\toggletrue{previousThird}
			}
		\togglefalse{bodyCon}
		}
}

% Adding constraints for a single alignment point and with the constraints below
\DeclareDocumentCommand{\oneAlignBelowAddConstraint}{m G{} G{}}{
	\iftoggle{bodyCon}{
		\bodyconstOneAlignBelow{#1}{#2}{#3}
		\togglefalse{bodyCon}
	}{
		\ifthenelse{\equal{#3}{}}{
			,\spanit\\& &&#1  #2\togglefalse{previousThird}
		}{
			,\spanit\\& &&#1  #2 && #3
			\toggletrue{previousThird}
		}
		\togglefalse{bodyCon}
	}
}

% Adding constraints below subject to for multiple references
\DeclareDocumentCommand{\BelowAddConstraintMult}{m G{} G{}}{
	\iftoggle{bodyCon}{
		\bodyconstBelowMult{#1}{#2}{#3}
		\togglefalse{bodyCon}
	}{
		\ifthenelse{\equal{#3}{}}{
			\ifthenelse{\equal{#2}{}}{
				,\spanit\\&&&#1  #2
			}{
			,\spanit\\ &&#1  &#2
			}
			\togglefalse{previousThird}
		}{
			\ifthenelse{\equal{#2}{}}{
				,\spanit\\&&&#1  #2 && #3
			}{
			,\spanit\\ &&#1  &#2&& #3}
		\toggletrue{previousThird}
		}
		\togglefalse{bodyCon}
	}
}

% Adding constraints for a single alignment point and with the constraints below for multiple references
\DeclareDocumentCommand{\oneAlignBelowAddConstraintMult}{m G{} G{}}{
	\iftoggle{bodyCon}{
		\bodyconstOneAlignBelowMult{#1}{#2}
		\togglefalse{bodyCon}
	}{
		\ifthenelse{\equal{#3}{}}{
			,\spanit\\& &&#1  #2 \togglefalse{previousThird}
		}{
			,\spanit\\& &&#1  #2 && #3
			\toggletrue{previousThird}
		}
	\togglefalse{bodyCon}
}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  ------------- SELECTING TYPE OF FORMAT  -----------%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\selectConstraint}[1]{
	\ifthenelse{\equal{#1}{1}}{
		\let\addConstraint\BelowAddConstraint
	}{
	\ifthenelse{\equal{#1}{2}}{
		\let\addConstraint\oneAlignAddConstraint
	}{
	\ifthenelse{\equal{#1}{3}}{
		\let\addConstraint\oneAlignBelowAddConstraint
	}{
		\let\addConstraint\standardAddConstraint}
}
}
}

% Selecting for multiple references
\newcommand{\selectConstraintMult}[1]{
	\ifthenelse{\equal{#1}{1}}{
		\let\addConstraint\BelowAddConstraintMult
	}{
	\ifthenelse{\equal{#1}{2}}{
		\let\addConstraint\oneAlignAddConstraint
	}{
	\ifthenelse{\equal{#1}{3}}{
		\let\addConstraint\oneAlignBelowAddConstraintMult
	}{
	\let\addConstraint\standardAddConstraint}
}
}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  ------------- SETTING DEFAULT FORMAT  -------------%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\setStandardMini}{
	\toggletrue{bodyCon}
	\let\addConstraint\standardAddConstraint	
}


\newcommand{\breakObjectiveOneConstraint}[1]{&&&#1\\}



%MINIMIZATION ENVIRONMENTS

\NewEnviron{mini}[5][]{%
\selectConstraint{#1}
\let\addConstraint\standardAddConstraint
	\begin{equation}
	#4
	\begin{alignedat}{5}
	\bodyobj{#2}{#3}{minimize}{#5}
	\BODY
	\end{alignedat}
	\end{equation}
\setStandardMini
}

\NewEnviron{argmini}[5][]{%
\selectConstraint{#1}
	\begin{equation}
	#4
	\begin{alignedat}{5}
	\bodyobj{#2}{#3}{arg~min}{#5}
	\BODY
	\end{alignedat}
	\end{equation}
\setStandardMini
}

\NewEnviron{mini*}[5][]{%
\selectConstraint{#1}
	\begin{alignat*}{5}
	\bodyobj{#2}{#3}{minimize}{#5}
	\BODY
	\end{alignat*}
\setStandardMini
}

\NewEnviron{argmini*}[5][]{%
\selectConstraint{#1}
	\begin{alignat*}{5}
	\bodyobj{#2}{#3}{arg~mini}{#5}
	\BODY
	\end{alignat*}
\setStandardMini	
}


\NewEnviron{mini!}[5][]{%
\selectConstraintMult{#1}
	\begin{subequations}
		#4
		\begin{alignat}{5}
		\bodyobj{#2}{#3}{minimize}{#5}
		\BODY
		\end{alignat}
	\end{subequations}
\setStandardMini
}

\NewEnviron{argmini!}[5][]{%
\selectConstraintMult{#1}
	\begin{subequations}
		#4
		\begin{alignat}{5}
		\bodyobj{#2}{#3}{arg~min}{#5}
		\BODY
		\end{alignat}
	\end{subequations}	
\setStandardMini		
}

%MAXIMIZATION ENVIRONMENTS

\NewEnviron{maxi}[5][]{%
\selectConstraint{#1}
	\begin{equation}
	#4
	\begin{alignedat}{5}
	\bodyobj{#2}{#3}{maximize}{#5}
	\BODY
	\end{alignedat}
	\end{equation}
\setStandardMini
}

\NewEnviron{argmaxi}[5][]{%
\selectConstraint{#1}
	\begin{equation}
	#4
	\begin{alignedat}{5}
	\bodyobj{#2}{#3}{arg~maxi}{#5}
	\BODY
	\end{alignedat}
	\end{equation}
\setStandardMini
}

\NewEnviron{maxi*}[5][]{%
\selectConstraint{#1}
	\begin{alignat*}{5}
	\bodyobj{#2}{#3}{maximize}{#5}
	\BODY
	\end{alignat*}
\setStandardMini
}

\NewEnviron{argmaxi*}[5][]{%
\selectConstraint{#1}
	\begin{alignat*}{5}
	\bodyobj{#2}{#3}{arg~maxi}{#5}
	\BODY
	\end{alignat*}
\setStandardMini
}


\NewEnviron{maxi!}[5][]{%
\selectConstraintMult{#1}
	\begin{subequations}
		#4
		\begin{alignat}{5}
		\bodyobj{#2}{#3}{maximize}{#5}		
		\BODY
		\end{alignat}
	\end{subequations}	
\setStandardMini		
}

\NewEnviron{argmaxi!}[5][]{%
\selectConstraintMult{#1}
	\begin{subequations}
		#4
		\begin{alignat}{5}
		\bodyobj{#2}{#3}{arg~maxi}{#5}		
		\BODY
		\end{alignat}
	\end{subequations}
\setStandardMini			
}